<style>
header {
  margin: 1em;
  font-size: 2em;
}
#container { display: flex; }
canvas { border: solid; margin-right: 1em; }
select { width: 20em; }
</style>
<header>
  <span id="game">Game</span> &gt;&gt;
  <span id="sprite">Sprite</span> &gt;&gt;
  <span id="character">Character</span> &gt;&gt;
  <span id="action">Action</span>
</header>
<div id="container">
  <canvas id="canvas" width=750 height=750></canvas>
  <div>
    <input id="stepNumber" type="range" min="0" step="1" oninput="travel(this.value)">
    <label for="stepNumber">Step</label>
  </div>
</div>

<script>
  let log = []

  const example=`
  init 64 64
  dot 20,20 21,20
  color #663399
  dot 20,40 21,40 21,41 20,41
  `

  const scale = 10
  const offscreen = document.createElement('canvas')
  // document.body.append(offscreen)
  const pen = offscreen.getContext('2d')
  const ctx = canvas.getContext('2d')

  const sprite = {
    w: 64,
    h: 64,
    layers: [],
    selection: null,
    color: '#000000ff'
  }

  let mode = 'now'
  const callbackQueue = []

  function handleClick() {
    if (callbackQueue.length) {
      callbackQueue.shift()()
    }
  }

  const commands = { init, dot, color, select }

  function init(w, h) {
    sprite.w = w
    sprite.h = h
    sprite.layers.length = 0
    sprite.layers.push(pen.createImageData(w, h))
    sprite.selection = null

    canvas.width = w * scale
    canvas.height = h * scale
    ctx.imageSmoothingEnabled = false
    ctx.scale(scale, scale)

    offscreen.width = w
    offscreen.height = h
    pen.color = '#000000ff'
  }

  function dot(x, y) {
    pen.fillRect(x, y, 1, 1)
  }

  function color(color) {
    pen.fillStyle = color
  }

  function select(fields) {
  }

  function error(msg) {
    console.log(msg)
  }

  function nextStep() {
    const promise = new Promise(resolve => {
      if (mode == "now") resolve()
      else callbackQueue.push(resolve)
    })
    return promise
  }

  function step(command, fields) {
    command(...fields)
  }

  async function drawFromLog(line) {
    await nextStep()
    const fields = line.split(/\s+/)
    const command = commands[fields.shift()]
    if (!command) {
      error(`No command ${command}`)
      return
    }

    if (command == dot) {
      while (fields.length) {
        const coords = fields.shift().split(',')
        step(dot, coords)
      }
    } else {
      step(command, fields)
    }
    updateCanvas()
  }

  function updateCanvas() {
    const {w, h} = sprite
    const i = new Image()
    ctx.clearRect(0, 0, w, h)
    i.onload = _ => ctx.drawImage(i, 0, 0)
    i.src = offscreen.toDataURL()
  }

  function addOption(line) {
    const option = document.createElement('option')
    option.append(new Text(line))
    timeTravel.append(option)
  }

  function travel(index) {
    index = index | 0
    log.slice(0, index + 1).forEach(drawFromLog)
  }

  function drawExample() {
    log = example.match(/\S.+/g).map(line => line.trim())
    const index = log.length - 1
    stepNumber.max = index
    travel(index)
  }

  drawExample()
</script>
